<!DOCTYPE html>
<html>

    <head>
        <style>

            * { margin: 0; padding: 0; font-family: sans-serif; font-size: 12pt; color: #1e2f55; box-sizing: border-box; }
            html, body { width: 100%; height: 100%; }
            body { padding: 0; display: flex; flex-direction: row; }

            h1 { font-size: 16pt; margin-bottom: 12px; }
            h2 { margin: 16px 0; }

            label { color: #627088; }
            input { padding: 8px; width: 100%; border: 1px solid #e5e8ec; margin-bottom: 12px; }
            input.id { font-size: 8pt; padding: 10.5px; }
            input:read-only { background-color: #fafafa; color: #606060; }
            select { padding: 8px; width: 100%; border: 1px solid #e5e8ec; margin-bottom: 12px; }
            button { background: #f1f2f4; border: none; border-radius: 3px; padding: 8px; cursor: pointer; display: inline-block; }
            .delete { background-color: red; color: white; }

            .card { display: flex; flex-direction: column; border-right: 2px solid #e5e8ec; width: 318px; overflow: auto; padding: 16px }
            .hidden { display: none; }

            .links { flex: 1; overflow: auto; }
            .links input { display: none; }
            .links label { color: #627088; display: block; padding: 11px 13px 11px 32px; text-decoration: none; border-radius: 4px; user-select: none; background: no-repeat 9px center; background-size: 16px; }
            .links label:hover { background-color: #e5e8ec; cursor: pointer; }
            .links input:checked+label { color: #0445ae; background-color: #e5e8ec; }

            #link-users + label, #usersCard .links label { background-image: url(./images/user.png); }
            #link-usergroups + label, #usergroupsCard .links label { background-image: url(./images/group.png); }
            #link-permissions + label, #permissionsCard .links label { background-image: url(./images/unlock.png); }

        </style>

        <script type="module">

            const usersCard = document.getElementById('usersCard')
            const usersLinks = usersCard.querySelector('.links')
            const userDetailsCard = document.getElementById('userDetailsCard')
            const userNameHeader = document.getElementById('userNameHeader')
            const userIdInput = document.getElementById('userIdInput')
            const userNameInput = document.getElementById('userNameInput')
            const passwordInput = document.getElementById('passwordInput')
            const usergroupsOfUserDiv = document.getElementById('usergroupsOfUserDiv')

            const usergroupsCard = document.getElementById('usergroupsCard')
            const usergroupsLinks = usergroupsCard.querySelector('.links')
            const usergroupDetailsCard = document.getElementById('usergroupDetailsCard')
            const usergroupNameHeader = document.getElementById('usergroupNameHeader')
            const usergroupIdInput = document.getElementById('usergroupIdInput')
            const usergroupNameInput = document.getElementById('usergroupNameInput')
            const permissionsOfUsergroupDiv = document.getElementById('permissionsOfUsergroupDiv')

            const permissionsCard = document.getElementById('permissionsCard')
            const permissionsLinks = permissionsCard.querySelector('.links')
            const permissionDetailsCard = document.getElementById('permissionDetailsCard')
            const permissionLabelHeader = document.getElementById('permissionLabelHeader')
            const permissionIdInput = document.getElementById('permissionIdInput')
            const permissionLabelInput = document.getElementById('permissionLabelInput')
            const newPermissionButton = permissionsCard.querySelector('button.new')
            const savePermissionButton = permissionDetailsCard.querySelector('button.save')
            const deletePermissionButton = permissionDetailsCard.querySelector('button.delete')

            // Ein Auswahlfeld für eine Zugehörigkeit wird erzeugt
            function createAssignmentSelect(target_list, selected_usergroup_id) {
                const selectElement = document.createElement('select')
                if (!selected_usergroup_id) {
                    selectElement.innerHTML = '<option disabled selected value="ADDUSERGROUPASSIGNMENT">Hinzufügen ...</option>'
                }
                // Einen Eintrag für jede existierende Benutzergruppe
                for (const usergroup of usergroups) {
                    const optionElement = document.createElement('option')
                    optionElement.value = usergroup.id
                    optionElement.innerHTML = usergroup.name
                    if (usergroup.id === selected_usergroup_id) {
                        optionElement.selected = true
                    }
                    selectElement.appendChild(optionElement)
                }
                // Letzter Eintrag dient zum Löschen der Zugehörigkeit
                // Wird aber nur erzeugt, wenn eine Benutzergruppe selektiert ist
                if (selected_usergroup_id) {
                    const deleteOption = document.createElement('option')
                    deleteOption.value = 'DELETEUSERGROUPASSIGNMENT'
                    deleteOption.classList.add('delete')
                    deleteOption.innerHTML = 'Zugehörigkeit löschen'
                    selectElement.appendChild(deleteOption)
                }
                selectElement.addEventListener('change', () => {
                    // Feld löschen, wenn ausgewählt
                    if (selectElement.value === 'DELETEUSERGROUPASSIGNMENT') {
                        selectElement.parentNode.removeChild(selectElement)
                    }
                })
                return selectElement
            }

            // Ein Benutzer wurde in der Benutzerliste selektiert.
            // Die Benutzerdetailkarte wird angezeigt.
            async function selectUser(user_id) {
                // Benutzerinfos inklusive Gruppenzuordnung laden
                const userDetailsResponse = await fetch('/api/users/userdetails/' + user_id)
                if (userDetailsResponse.status === 200) {
                    const userDetails = await userDetailsResponse.json()
                    userNameHeader.innerHTML = userDetails.name
                    userIdInput.value = userDetails.id
                    userNameInput.value = userDetails.name
                    // Benutzergruppen laden
                    const usergroupsResponse = await fetch('/api/users/listusergroups')
                    if (usergroupsResponse.status === 200) {
                        const usergroups = await usergroupsResponse.json()
                        usergroups.sort((a, b) => a.name.localeCompare(b.name)) // Alphabetisch sortieren
                        // Select-Felder für alle Zugehörigkeiten erstellen
                        usergroupsOfUserDiv.innerHTML = ''
                        for (const usergroupId of userDetails.usergroupids) {
                            const selectElement = createUsergroupSelect(usergroups, usergroupId)
                            usergroupsOfUserDiv.appendChild(selectElement)
                        }
                        // Zusätzliches Feld erstellen, damit neue Zugehörigkeiten erstellt werden können
                        const additionalSelectElement = createUsergroupSelect(usergroups)
                        additionalSelectElement.addEventListener('change', () => {
                            const newUsergroupId = additionalSelectElement.value
                            // Neues Selectfeld vor dem letzten einfügen
                            const newSelectElement = createUsergroupSelect(usergroups, newUsergroupId)
                            usergroupsOfUserDiv.insertBefore(newSelectElement, additionalSelectElement)
                            additionalSelectElement.value = 'ADDUSERGROUPASSIGNMENT'
                            newSelectElement.focus()
                        })
                        usergroupsOfUserDiv.appendChild(additionalSelectElement)
                    }
                }
                // Benutzerdetailkarte anzeigen
                userDetailsCard.classList.remove('hidden')
            }
            
            // Klick-Handler für Karte in erster (linker) Spalte
            document.getElementById('link-users').addEventListener('click', async () => {
                // Karten ausblenden
                userDetailsCard.classList.add('hidden')
                usergroupsCard.classList.add('hidden')
                usergroupDetailsCard.classList.add('hidden')
                permissionsCard.classList.add('hidden')
                permissionDetailsCard.classList.add('hidden')
                // Benutzerliste laden
                usersLinks.innerHTML = ''
                const usersResponse = await fetch('/api/users/listusers')
                if (usersResponse.status === 200) {
                    const users = await usersResponse.json()
                    users.sort((a, b) => a.name.localeCompare(b.name)) // Alphabetisch sortieren
                    for (const user of users) {
                        const inputElement = document.createElement('input')
                        const inputElementId = 'link-user' + user.id
                        inputElement.setAttribute('type', 'radio')
                        inputElement.setAttribute('id', inputElementId)
                        inputElement.setAttribute('name', 'link-user')
                        inputElement.addEventListener('click', async () => {
                            await selectUser(user.id)
                        })
                        usersLinks.appendChild(inputElement)
                        const labelElement = document.createElement('label')
                        labelElement.setAttribute('for', inputElementId)
                        labelElement.innerHTML = user.name
                        usersLinks.appendChild(labelElement)
                    }
                }
                // Benutzerlistenkarte anzeigen
                usersCard.classList.remove('hidden')
            })

            



            /********** Benutzergruppen **********/



            // Eine Benutzergruppe wurde in der Benutzergruppenliste selektiert.
            // Die Benutzergruppendetailkarte wird angezeigt.
            async function selectUsergroup(usergroup_id) {
                // Benutzergruppeninfos laden
                const usergroupDetailsResponse = await fetch('/api/users/usergroupdetails/' + permission_id)
                if (usergroupDetailsResponse.status === 200) {
                    const usergroupDetails = await usergroupDetailsResponse.json()
                    usergroupNameHeader.innerHTML = usergroupDetails.name
                    usergroupIdInput.value = usergroupDetails.id
                    usergroupNameInput.value = usergroupDetails.name
                    // Berechtigungen laden
                    const permissionsResponse = await fetch('/api/users/listpermissions')
                    if (permissionsResponse.status === 200) {
                        const permissions = await permissionsResponse.json()
                        permissions.sort((a, b) => a.name.localeCompare(b.name)) // Alphabetisch sortieren
                        // Select-Felder für alle Zugehörigkeiten erstellen
                        permissionsOfUsergroupDiv.innerHTML = ''
                        for (const permissionId of usergroupDetails.permissionids) {
                            const selectElement = createPermissionSelect(usergroups, permissionId)
                            // TODO HIER
                            usergroupsOfUserDiv.appendChild(selectElement)
                        }
                        // Zusätzliches Feld erstellen, damit neue Zugehörigkeiten erstellt werden können
                        const additionalSelectElement = createUsergroupSelect(usergroups)
                        additionalSelectElement.addEventListener('change', () => {
                            const newUsergroupId = additionalSelectElement.value
                            // Neues Selectfeld vor dem letzten einfügen
                            const newSelectElement = createUsergroupSelect(usergroups, newUsergroupId)
                            usergroupsOfUserDiv.insertBefore(newSelectElement, additionalSelectElement)
                            additionalSelectElement.value = 'ADDUSERGROUPASSIGNMENT'
                            newSelectElement.focus()
                        })
                        usergroupsOfUserDiv.appendChild(additionalSelectElement)
                    }
                }
                // Berechtigungsdetailkarte anzeigen
                deletePermissionButton.classList.remove('hidden')
                permissionDetailsCard.classList.remove('hidden')
            }
            
            // Aktualisiert die Berechtigungsliste
            async function updatePermissionsList() {
                permissionsLinks.innerHTML = ''
                const permissionsResponse = await fetch('/api/users/listpermissions')
                if (permissionsResponse.status === 200) {
                    const permissions = await permissionsResponse.json()
                    permissions.sort((a, b) => a.name.localeCompare(b.name)) // Alphabetisch sortieren
                    for (const permission of permissions) {
                        const inputElement = document.createElement('input')
                        const inputElementId = 'link-permission-' + permission.id
                        inputElement.setAttribute('type', 'radio')
                        inputElement.setAttribute('id', inputElementId)
                        inputElement.setAttribute('name', 'link-permission')
                        inputElement.addEventListener('click', async () => {
                            await selectPermission(permission.id)
                        })
                        permissionsLinks.appendChild(inputElement)
                        const labelElement = document.createElement('label')
                        labelElement.setAttribute('for', inputElementId)
                        labelElement.innerHTML = permission.name
                        permissionsLinks.appendChild(labelElement)
                    }
                }
            }

            // Neue Berechtigung vorbereiten
            newPermissionButton.addEventListener('click', () => {
                // Detailfelder leeren
                permissionNameHeader.innerHTML = 'Neue Berechtigung'
                permissionIdInput.value = ''
                permissionNameInput.value = ''
                // Selektion in Liste entfernen
                permissionsLinks.querySelectorAll(`input`).forEach(input => input.checked = false)
                // Berechtigungsdetailkarte anzeigen
                deletePermissionButton.classList.add('hidden')
                permissionDetailsCard.classList.remove('hidden')
            })

            // Berechtigung speichern
            savePermissionButton.addEventListener('click', async () => {
                const permission = {
                    id: permissionIdInput.value,
                    name: permissionNameInput.value
                }
                const response = await fetch('/api/users/savepermission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(permission)
                })
                if (response.status === 200) {
                    const permissionId = (await response.json()).id
                    // Berechtigungsliste neu laden
                    await updatePermissionsList()
                    await selectPermission(permissionId)
                    permissionsLinks.querySelector(`[id="link-permission-${permissionId}"]`).checked = true
                    alert('Die Berechtigung wurde gespeichert.')
                }
            })

            // Berechtigung löschen
            deletePermissionButton.addEventListener('click', async () => {
                // Sicherheitsabfrage
                if (!confirm('Soll die Berechtigung wirklich gelöscht werden?')) return
                const response = await fetch('/api/users/deletepermission/' + permissionIdInput.value, { method: 'DELETE' })
                if (response.status === 200) {
                    // Detailkarte ausblenden
                    permissionDetailsCard.classList.add('hidden')
                    // Berechtigungsliste neu laden
                    await updatePermissionsList()
                    alert('Die Berechtigung wurde gelöscht.')
                }
            })

            // Feature Berechtigungen auswählen
            document.getElementById('link-permissions').addEventListener('click', async () => {
                // Karten ausblenden
                usersCard.classList.add('hidden')
                userDetailsCard.classList.add('hidden')
                usergroupsCard.classList.add('hidden')
                usergroupDetailsCard.classList.add('hidden')
                permissionDetailsCard.classList.add('hidden')
                // Berechtigungsliste laden
                await updatePermissionsList()
                // Berechtigungslistenkarte anzeigen
                permissionsCard.classList.remove('hidden')
            })



            /********** Berechtigungen **********/



            // Eine Berechtigung wurde in der Berechtigungsliste selektiert.
            // Die Berechtigungsdetailkarte wird angezeigt.
            async function selectPermission(permission_id) {
                // Berechtigungsinfos laden
                const permissionDetailsResponse = await fetch('/api/users/permissiondetails/' + permission_id)
                if (permissionDetailsResponse.status === 200) {
                    const permissionDetails = await permissionDetailsResponse.json()
                    permissionNameHeader.innerHTML = permissionDetails.name
                    permissionIdInput.value = permissionDetails.id
                    permissionNameInput.value = permissionDetails.name
                }
                // Berechtigungsdetailkarte anzeigen
                deletePermissionButton.classList.remove('hidden')
                permissionDetailsCard.classList.remove('hidden')
            }
            
            // Aktualisiert die Berechtigungsliste
            async function updatePermissionsList() {
                permissionsLinks.innerHTML = ''
                const permissionsResponse = await fetch('/api/users/listpermissions')
                if (permissionsResponse.status === 200) {
                    const permissions = await permissionsResponse.json()
                    permissions.sort((a, b) => a.name.localeCompare(b.name)) // Alphabetisch sortieren
                    for (const permission of permissions) {
                        const inputElement = document.createElement('input')
                        const inputElementId = 'link-permission-' + permission.id
                        inputElement.setAttribute('type', 'radio')
                        inputElement.setAttribute('id', inputElementId)
                        inputElement.setAttribute('name', 'link-permission')
                        inputElement.addEventListener('click', async () => {
                            await selectPermission(permission.id)
                        })
                        permissionsLinks.appendChild(inputElement)
                        const labelElement = document.createElement('label')
                        labelElement.setAttribute('for', inputElementId)
                        labelElement.innerHTML = permission.name
                        permissionsLinks.appendChild(labelElement)
                    }
                }
            }

            // Neue Berechtigung vorbereiten
            newPermissionButton.addEventListener('click', () => {
                // Detailfelder leeren
                permissionNameHeader.innerHTML = 'Neue Berechtigung'
                permissionIdInput.value = ''
                permissionNameInput.value = ''
                // Selektion in Liste entfernen
                permissionsLinks.querySelectorAll(`input`).forEach(input => input.checked = false)
                // Berechtigungsdetailkarte anzeigen
                deletePermissionButton.classList.add('hidden')
                permissionDetailsCard.classList.remove('hidden')
            })

            // Berechtigung speichern
            savePermissionButton.addEventListener('click', async () => {
                const permission = {
                    id: permissionIdInput.value,
                    name: permissionNameInput.value
                }
                const response = await fetch('/api/users/savepermission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(permission)
                })
                if (response.status === 200) {
                    const permissionId = (await response.json()).id
                    // Berechtigungsliste neu laden
                    await updatePermissionsList()
                    await selectPermission(permissionId)
                    permissionsLinks.querySelector(`[id="link-permission-${permissionId}"]`).checked = true
                    alert('Die Berechtigung wurde gespeichert.')
                }
            })

            // Berechtigung löschen
            deletePermissionButton.addEventListener('click', async () => {
                // Sicherheitsabfrage
                if (!confirm('Soll die Berechtigung wirklich gelöscht werden?')) return
                const response = await fetch('/api/users/deletepermission/' + permissionIdInput.value, { method: 'DELETE' })
                if (response.status === 200) {
                    // Detailkarte ausblenden
                    permissionDetailsCard.classList.add('hidden')
                    // Berechtigungsliste neu laden
                    await updatePermissionsList()
                    alert('Die Berechtigung wurde gelöscht.')
                }
            })

            // Feature Berechtigungen auswählen
            document.getElementById('link-permissions').addEventListener('click', async () => {
                // Karten ausblenden
                usersCard.classList.add('hidden')
                userDetailsCard.classList.add('hidden')
                usergroupsCard.classList.add('hidden')
                usergroupDetailsCard.classList.add('hidden')
                permissionDetailsCard.classList.add('hidden')
                // Berechtigungsliste laden
                await updatePermissionsList()
                // Berechtigungslistenkarte anzeigen
                permissionsCard.classList.remove('hidden')
            })

        </script>

    </head>

    <body>

        <div class="card" id="featuresCard">
            <h1>Benutzerverwaltung</h1>
            <div class="links">
                <input type="radio" id="link-users" name="link"><label for="link-users">Benutzer</label>
                <input type="radio" id="link-usergroups" name="link"><label for="link-usergroups">Benutzergruppen</label>
                <input type="radio" id="link-permissions" name="link"><label for="link-permissions">Berechtigungen</label>
            </div>
        </div>

        <div class="card hidden" id="usersCard">
            <h1>Benutzer</h1>
            <div class="toolbar">
                <button>Neu</button>
            </div>
            <div class="links"></div>
        </div>

        <div class="card hidden" id="userDetailsCard">
            <h1 id="userNameHeader"></h1>
            <div class="toolbar">
                <button class="save">Speichern</button>
                <button class="delete">Löschen</button>
            </div>

            <h2>Details</h2>
            <label>Id</label>
            <input class="id" id="userIdInput" readonly />
            <label>Benutzername</label>
            <input id="userNameInput" readonly />
            <label>Neues Passwort</label>
            <input id="passwordInput" type="password" />

            <h2>Gruppenzugehörigkeit</h2>
            <div id="usergroupsOfUserDiv"></div>
        </div>

        <div class="card hidden" id="usergroupsCard">
            <h1>Benutzergruppen</h1>
            <div class="toolbar">
                <button>Neu</button>
            </div>
            <div class="links"></div>
        </div>

        <div class="card hidden" id="usergroupDetailsCard">
            <h1 id="usergroupNameHeader"></h1>
            <div class="toolbar">
                <button class="save">Speichern</button>
                <button class="delete">Löschen</button>
            </div>

            <h2>Details</h2>
            <label>Id</label>
            <input class="id" id="usergroupIdInput" readonly />
            <label>Gruppenname</label>
            <input id="usergroupNameInput" />

            <h2>Berechtigungen</h2>
            <div id="permissionsOfUsergroupDiv"></div>
        </div>

        <div class="card hidden" id="permissionsCard">
            <h1>Berechtigungen</h1>
            <div class="toolbar">
                <button class="new">Neu</button>
            </div>
            <div class="links"></div>
        </div>

        <div class="card hidden" id="permissionDetailsCard">
            <h1 id="permissionNameHeader"></h1>
            <div class="toolbar">
                <button class="save">Speichern</button>
                <button class="delete">Löschen</button>
            </div>

            <h2>Details</h2>
            <label>Id</label>
            <input class="id" id="permissionIdInput" readonly />
            <label>Bezeichnung</label>
            <input id="permissionNameInput" />
        </div>

    </body>

</html>