<!DOCTYPE html>
<html>

    <head>
        <!-- TODO: Stylesheets in home-Modul auslagern -->
        <style>

            * { margin: 0; padding: 0; font-family: sans-serif; font-size: 12pt; color: #1e2f55; box-sizing: border-box; }
            html, body { width: 100%; height: 100%; }
            body { padding: 0; display: flex; flex-direction: row; }

            h1 { font-size: 16pt; margin-bottom: 12px; }
            h2 { margin: 16px 0; }

            label { color: #627088; }
            input { padding: 8px; width: 100%; border: 1px solid #e5e8ec; margin-bottom: 12px; }
            input:read-only { background-color: #fafafa; color: #606060; }
            select { padding: 8px; width: 100%; border: 1px solid #e5e8ec; margin-bottom: 12px; }
            button { background: #f1f2f4; border: none; border-radius: 3px; padding: 8px; cursor: pointer; display: inline-block; }
            .delete { background-color: red; color: white; }

            .card { display: flex; flex-direction: column; border-right: 2px solid #e5e8ec; width: 318px; overflow: auto; padding: 16px }

            .links { flex: 1; overflow: auto; }
            .links input { display: none; }
            .links label { color: #627088; display: block; padding: 11px 13px 11px 32px; text-decoration: none; border-radius: 4px; user-select: none; background: no-repeat 9px center; background-size: 16px; position: relative; }
            .links label:hover { background-color: #e5e8ec; cursor: pointer; }
            .links input:checked+label { color: #0445ae; background-color: #e5e8ec; }

        </style>

        <script type="module">

            import { createListCard, createListAndDetailsCards } from '/js/cardhelper.mjs'

            /********** Features **********/

            let featuresCard
            const featuresData = [
                { handler: createUsersCard, id: 'users', label: 'Benutzer', icon: './images/user.png' },
                { handler: createUsergroupsCard, id: 'usergroups', label: 'Benutzergruppen', icon: './images/group.png' },
                { handler: createPermissionsCard, id: 'permissions', label: 'Berechtigungen', icon: './images/unlock.png' }
            ]
            const featuresMetadata = {
                listTitle: 'Benutzerverwaltung',
                identifierPropertyName: 'id',
                titlePropertyName: 'label',
                iconPropertyName: 'icon'
            }
            const featuresSelectHandler = async (selected_object) => {
                // Alle weiteren geöffneten Karten schließen
                while (featuresCard.nextSibling) {
                    featuresCard.nextSibling.remove()
                }
                // Selektierte Karte anhand seines Handlers einbinden
                const selectedCard = await selected_object.handler()
                featuresCard.parentNode.appendChild(selectedCard)
            }
            featuresCard = createListCard(featuresData, featuresMetadata, featuresSelectHandler, undefined)
            document.body.appendChild(featuresCard)

            /********** Benutzer **********/

            async function createUsersCard() {
                // Metadaten vorbereiten
                const usergroupsReponse = await fetch('/api/users/listusergroups')
                if (usergroupsReponse.status !== 200) return
                const usergroups = await usergroupsReponse.json()
                // In Metadatenstruktur mappen
                const usergroupsMetadata = usergroups.map(usergroup => {
                    return {
                        value: usergroup.id,
                        label: usergroup.name
                    }
                })
                const usersMetadata = {
                    listTitle: 'Benutzer',
                    identifierPropertyName: 'id',
                    titlePropertyName: 'name',
                    iconPropertyName: 'icon',
                    listApi: '/api/users/listusers',
                    saveApi: '/api/users/saveuser',
                    deleteApi: '/api/users/deleteuser',
                    canCreate: true,
                    fields: [
                        { property: 'id', label: 'Id', type: 'text', readonly: true },
                        { property: 'name', label: 'Benutzername', type: 'text' },
                        { property: 'password', label: 'Neues Passwort', type: 'password' },
                        { property: 'usergroupids', label: 'Benutzergruppen', type: 'multiselect', options: usergroupsMetadata }
                    ]
                }
                const usersListCard = await createListAndDetailsCards(usersMetadata)
                return usersListCard
            }
        
            /********** Benutzergruppen **********/

            async function createUsergroupsCard() {
                // Metadaten vorbereiten
                const permissionsReponse = await fetch('/api/users/listpermissions')
                if (permissionsReponse.status !== 200) return
                const permissions = await permissionsReponse.json()
                // In Metadatenstruktur mappen
                const permissionsMetadata = permissions.map(permission => {
                    return {
                        value: permission.id,
                        label: permission.name
                    }
                })
                const usergroupsMetadata = {
                    listTitle: 'Benutzergruppen',
                    identifierPropertyName: 'id',
                    titlePropertyName: 'name',
                    iconPropertyName: 'icon',
                    listApi: '/api/users/listusergroups',
                    saveApi: '/api/users/saveusergroup',
                    deleteApi: '/api/users/deleteusergroup',
                    canCreate: true,
                    fields: [
                        { property: 'id', label: 'Id', type: 'text', readonly: true },
                        { property: 'name', label: 'Name', type: 'text' },
                        { property: 'permissionids', label: 'Berechtigungen', type: 'multiselect', options: permissionsMetadata }
                    ]
                }
                const usergroupsListCard = await createListAndDetailsCards(usergroupsMetadata)
                return usergroupsListCard
            }
        
            /********** Berechtigungen **********/

            async function createPermissionsCard() {
                // Metadaten vorbereiten
                // Berechtigungen können nicht gelöscht werden, da sie üblicherweise von Modulen erstellt und benötigt werden
                const permissionsMetadata = {
                    listTitle: 'Berechtigungen',
                    identifierPropertyName: 'id',
                    titlePropertyName: 'name',
                    iconPropertyName: 'icon',
                    listApi: '/api/users/listpermissions',
                    saveApi: '/api/users/savepermission',
                    canCreate: false,
                    fields: [
                        { property: 'id', label: 'Id', type: 'text', readonly: true },
                        { property: 'name', label: 'Name', type: 'text' }
                    ]
                }
                const permissionsListCard = await createListAndDetailsCards(permissionsMetadata)
                return permissionsListCard
            }

        </script>

    </head>

    <body></body>

</html>